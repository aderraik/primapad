<!DOCTYPE html>
<html>
<head>
    <title>JustAPad</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- start bower -->
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/jsdiff/diff.js"></script>
    <!-- end bower -->

    <script src="sockjs-0.3.4.js"></script>
    <script src="stomp.js"></script>

    <script type="text/javascript">
        var text = null;
        var stompClient = null;

        function connect() {
            text = $('#textarea').val();
            var socket = new SockJS('/justapad');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                stompClient.subscribe('/topic/justapad', function(diff){

                    var patch = JSON.parse(diff.body).patch;
                    applyDiff(patch);
                });
            });
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
        }

        $(function () {
            $('#textarea').on('keyup input propertychange paste change', function (e) {
                var newText = $('#textarea').val();
                if (text == newText) {
                    return;
                }
                var patch = diff(text, newText);
                // need to add patch version/point in time, so sender ignore when receives it
                stompClient.send("/app/justapad", {}, JSON.stringify({ 'patch': patch }));
                text = newText;
            });
        });

        function diff(oldText, newText) {
            // currently returned diff has the entire text
            // need to change to return just what has changed
            return JsDiff.diffChars(oldText, newText);
        }

        function applyDiff(patch) {
            var display = document.getElementById('display');
            display.innerHTML = '';

            patch.forEach(function(part){
                // green for additions, red for deletions
                // grey for common parts
                var color = part.added ? 'green' :
                        part.removed ? 'red' : 'grey';

                var span = document.createElement('span');
                span.style.color = color;
                span.appendChild(document.createTextNode(part.value));
                display.appendChild(span);
            });
        }
    </script>
</head>
<body onload="connect()">
    <noscript>
        <h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!</h2>
    </noscript>

    <div class="container-fluid">
        <div class="input-group">
            <label for="textarea">Text Area</label>
            <textarea id="textarea" class="form-control custom-control" rows="10" style="resize:none"></textarea>
        </div>
        <pre id="display"></pre>
    </div>
</body>
</html>